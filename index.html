<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>YouTube Transcription</title>
  <style>
    :root{
      --bg:#fff; --card:#ffffff; --text:#1f2030; --muted:#5c6473;
      --accent:#4c7dff; --accent-2:#3dd6a5; --danger:#c0392b;
      --border:rgba(0,0,0,.12);
      --input-bg:#ffffff; --input-text:#1f2030;
      --track:#eef1f6; --bar-from:#4c7dff; --bar-to:#8fb0ff;
      --drop-bg:#fcfcff; --drop-border:#cfd6ef;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--text);}
    .wrap{max-width:980px;margin:40px auto;padding:0 16px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.06); overflow:hidden;}
    .head{padding:22px 24px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:12px}
    .title{font-weight:700; font-size:20px;}
    .badge{padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border); color:var(--muted)}
    .body{padding:24px}
    label{display:block; color:var(--muted); font-size:13px; margin:10px 0 6px}
    input[type="text"], select, input[type="number"]{
      width:100%; padding:12px 14px; background:var(--input-bg); color:var(--input-text);
      border:1px solid var(--border); border-radius:10px; outline:none;
    }
    input::placeholder{color:#9aa2b2}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:880px){ .grid{grid-template-columns: 1.2fr .7fr .7fr .9fr} }
    .row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .btn{appearance:none; border:0; padding:12px 14px; border-radius:10px; cursor:pointer; font-weight:600; letter-spacing:.2px; transition:.15s}
    .btn-primary{background:var(--accent); color:#fff}
    .btn-ghost{background:transparent; color:var(--accent); border:1px solid var(--accent)}
    .btn-danger{background:var(--danger); color:#fff}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .status{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 14px}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--border); color:var(--muted); font-size:12px; background:#fff}
    .chip .dot{width:8px; height:8px; border-radius:50%;}
    .chip.active{color:var(--text); border-color:var(--accent)}
    .chip.active .dot{background:var(--accent)}
    .chip.done{color:#1e8e5b; border-color:#bfe9d8; background:#e9fbf5}
    .chip.done .dot{background:var(--accent-2)}
    .chip.error{color:#a73a3a; border-color:#f3c2c2; background:#ffe9e9}
    .progress{height:10px; background:var(--track); border:1px solid var(--border); border-radius:999px; overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--bar-from),var(--bar-to)); transition:width .2s ease}
    .help{color:var(--muted); font-size:12px; margin-top:8px}
    .out{margin-top:18px; padding:16px; background:#f7f7fb; border:1px solid var(--border); color:var(--text); white-space:pre-wrap; border-radius:12px; display:none}
    .meta{margin-top:10px; padding:10px; border:1px dashed var(--border); color:#40465a; font-size:12px; border-radius:10px; display:none; background:#fff}
    .alert{margin-top:12px; padding:12px; border-radius:12px; display:none; font-size:14px; border:1px solid}
    .alert.info{background:#eef3ff; color:#2b3e86; border-color:#cfdafc}
    .alert.success{background:#e9fbf5; color:#1e8e5b; border-color:#bfe9d8}
    .alert.error{background:#ffe9e9; color:#a73a3a; border-color:#f3c2c2}
    .footer{display:flex; gap:10px; margin-top:14px; justify-content:flex-end;}
    a.dl{display:none; text-decoration:none}

    /* Segmented toggle */
    .seg{display:inline-flex; border:1px solid var(--border); border-radius:10px; overflow:hidden; background:#fff}
    .seg button{border:0; padding:10px 14px; cursor:pointer; background:transparent; color:#4a5670; font-weight:600}
    .seg button.active{background:var(--accent); color:#fff}

    /* Drop zone */
    .drop{
      margin-top:16px; padding:16px; border:2px dashed var(--drop-border);
      background:var(--drop-bg); border-radius:14px; color:#48506a;
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .drop.highlight{ background:#f8fbff; border-color:var(--accent); }
    .file-pill{display:none; padding:6px 10px; border-radius:999px; background:#f1f4ff; border:1px solid var(--border); color:#2b3e86; font-size:12px}
    .file-pill a{margin-left:8px; color:#a23; text-decoration:none; font-weight:700}
    #fileInput{display:none}

    /* LOGIN (light card) */
    .overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:transparent; z-index:9999}
    .login-wrap{min-height:100svh; width:100%; display:grid; place-items:center; background:var(--bg); padding:16px;}
    .login{width:min(92vw,420px); background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:24px;}
    .login h2{margin:0 0 8px}
    .login p{margin:0 0 14px; color:var(--muted)}
    .login input{width:100%; padding:12px 14px; background:#fff; color:#1f2030; border:1px solid var(--border); border-radius:10px; outline:none;}
    .login .row{display:flex; gap:12px; margin-top:12px; justify-content:flex-end}
    .login .msg{margin-top:10px; font-size:13px; display:none}
    .msg-ok{color:#1e8e5b}
    .msg-err{color:#b52424}

    /* Greeting flash */
    .greet{position:fixed; top:18px; left:50%; transform:translateX(-50%); background:#fff; border:1px solid var(--border); border-radius:14px; padding:14px 18px; font-weight:700; box-shadow:0 8px 24px rgba(0,0,0,.08); display:none; z-index:10000}

    /* Timers */
    .timers{margin-top:8px; font-size:12px; color:#4a5670}
  </style>
</head>
<body>
  <!-- Client login (for GH Pages) -->
  <div class="overlay" id="loginOverlay">
    <div class="login-wrap">
      <div class="login">
        <h2>Welcome</h2>
        <p>Enter password to continue</p>
        <input id="pw" type="password" placeholder="Password"/>
        <div class="row">
          <button class="btn btn-primary" id="enter">Enter</button>
        </div>
        <div class="msg msg-err" id="loginErr">Nope.</div>
        <div class="msg msg-ok"  id="loginOk">Looks good.</div>
      </div>
    </div>
  </div>
  <div class="greet" id="greet"></div>

  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="title">ðŸŽ§ YouTube Transcription</div>
        <div class="badge" id="gpuMeta">GPU: â€”</div>
      </div>
      <div class="body">
        <!-- Mode + Model -->
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="seg">
            <button id="modeUrl" class="active" type="button">YouTube URL</button>
            <button id="modeFile" type="button">Upload File</button>
          </div>
          <div class="row" style="gap:8px">
            <label for="modelKey" style="margin:0">Model</label>
            <select id="modelKey">
              <option value="">Default</option>
            </select>
          </div>
        </div>

        <!-- URL mode -->
        <div id="urlMode">
          <div class="grid" style="margin-top:12px">
            <div>
              <label for="youtube-url">YouTube URL</label>
              <input id="youtube-url" type="text" placeholder="https://youtu.be/â€¦">
            </div>
            <div>
              <label for="language">Language</label>
              <select id="language">
                <option value="en" selected>English</option>
                <option value="ar">Arabic</option>
                <option value="fr">French</option>
                <option value="es">Spanish</option>
                <option value="de">German</option>
              </select>
            </div>
            <div>
              <label for="chunk">Chunk (sec)</label>
              <input id="chunk" type="number" min="5" max="120" value="30">
            </div>
            <div class="timers" id="timersUrl">Total: â€”</div>
          </div>
        </div>

        <!-- File mode -->
        <div id="fileMode" style="display:none; margin-top:12px">
          <div class="row" style="align-items:flex-start">
            <div style="flex:1">
              <label>File</label>
              <div class="drop" id="drop">
                <button class="btn btn-ghost" id="pickBtn" type="button">Choose file</button>
                <span class="file-pill" id="filePill"></span>
                <input type="file" id="fileInput" accept=".mp3,.wav,.m4a,.mp4,.mkv,.webm,.mov,.aac,.flac,.ogg,.opus,video/*,audio/*"/>
              </div>
              <div class="help">Formats: mp3, wav, m4a, mp4, webm, mkv, mov, flac, ogg, opus</div>
              <div class="timers" id="timersFile">Total: â€”</div>
            </div>
            <div style="min-width:220px">
              <label for="languageF">Language</label>
              <select id="languageF">
                <option value="en" selected>English</option>
                <option value="ar">Arabic</option>
                <option value="fr">French</option>
                <option value="es">Spanish</option>
                <option value="de">German</option>
              </select>
              <label for="chunkF" style="margin-top:10px">Chunk (sec)</label>
              <input id="chunkF" type="number" min="5" max="120" value="30">
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:16px">
          <button class="btn btn-primary" id="go">Generate Transcript</button>
          <button class="btn btn-ghost" id="logout">Logout</button>
        </div>

        <div class="status" id="statusChips" style="margin-top:10px">
          <span class="chip" data-step="queue"><span class="dot"></span> Queued</span>
          <span class="chip" data-step="download"><span class="dot"></span> Downloading</span>
          <span class="chip" data-step="transcribe"><span class="dot"></span> Transcribing</span>
          <span class="chip" data-step="finalize"><span class="dot"></span> Finalizing</span>
        </div>
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div class="help" id="hint">Ready.</div>

        <div class="alert info" id="note"></div>
        <div class="alert error" id="err"></div>
        <div class="alert success" id="ok"></div>

        <div class="meta" id="meta"></div>
        <pre class="out" id="out"></pre>
        <div class="footer">
          <button class="btn btn-ghost" id="copyBtn" style="display:none">Copy</button>
          <a class="btn btn-ghost dl" id="dl" download="transcript.txt">Download transcript</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === Configure API base (set to ngrok for GH Pages) ===
    const API_BASE = (location.hostname.endsWith('github.io'))
      ? 'https://fair-joint-dinosaur.ngrok-free.app'   // <-- update when ngrok rotates
      : '';
    const EP = {
      check:        API_BASE + '/auth/check',
      login:        API_BASE + '/auth/login',
      logout:       API_BASE + '/auth/logout',
      transcribe:   API_BASE + '/transcribe',
      transcribeF:  API_BASE + '/transcribe_file',
      health:       API_BASE + '/healthz',
      models:       API_BASE + '/models',
    };

    // --- Themes ---
    const THEMES = {
      pink:{bg:'#fff5fb',card:'#fff',text:'#1f2030',muted:'#6a5b6f',accent:'#e16bbd',accent2:'#ff9ecf',border:'rgba(0,0,0,.10)',inputBg:'#fff',inputText:'#1f2030',track:'#ffe6f3',barFrom:'#ff7fc7',barTo:'#ffb3dd'},
      light:{bg:'#fff',card:'#fff',text:'#1f2030',muted:'#5c6473',accent:'#4c7dff',accent2:'#3dd6a5',border:'rgba(0,0,0,.12)',inputBg:'#fff',inputText:'#1f2030',track:'#eef1f6',barFrom:'#4c7dff',barTo:'#8fb0ff'}
    };
    function applyTheme(name){
      const t = THEMES[name] || THEMES.light, r = document.documentElement.style;
      r.setProperty('--bg', t.bg); r.setProperty('--card', t.card);
      r.setProperty('--text', t.text); r.setProperty('--muted', t.muted);
      r.setProperty('--accent', t.accent); r.setProperty('--accent-2', t.accent2);
      r.setProperty('--border', t.border); r.setProperty('--input-bg', t.inputBg);
      r.setProperty('--input-text', t.inputText); r.setProperty('--track', t.track);
      r.setProperty('--bar-from', t.barFrom); r.setProperty('--bar-to', t.barTo);
      document.body.style.background = t.bg;
    }

    // --- UI refs ---
    const $ = id => document.getElementById(id);
    const loginOverlay = $('loginOverlay'), loginErr = $('loginErr'), loginOk = $('loginOk'), enterBtn = $('enter'), pw = $('pw');
    const greet = $('greet');

    const go = $('go'), logoutBtn = $('logout');
    const modeUrlBtn = $('modeUrl'), modeFileBtn = $('modeFile');
    const urlMode = $('urlMode'), fileMode = $('fileMode');
    const urlI = $('youtube-url'), langI = $('language'), chunkI = $('chunk');
    const langF = $('languageF'), chunkF = $('chunkF');
    const drop = $('drop'), fileInput = $('fileInput'), pickBtn = $('pickBtn'), filePill = $('filePill');
    const chips = document.querySelectorAll('.chip');
    const bar = $('bar'), hint = $('hint');
    const note = $('note'), err = $('err'), ok = $('ok');
    const out = $('out'), dl = $('dl'), meta = $('meta'), gpuMeta = $('gpuMeta');
    const copyBtn = $('copyBtn');
    const timersUrl = $('timersUrl'), timersFile = $('timersFile');
    const modelKeySel = $('modelKey');

    // --- State ---
    let pickedFile = null;
    let authed = false;
    let AUTH_TOKEN = null;  // used only on GH Pages (X-Auth header)

    // --- Mode switching ---
    function activateUrlMode(){
      modeUrlBtn.classList.add('active'); modeFileBtn.classList.remove('active');
      urlMode.style.display = ''; fileMode.style.display = 'none';
      pickedFile = null; filePill.textContent=''; filePill.style.display='none'; fileInput.value='';
    }
    function activateFileMode(){
      modeFileBtn.classList.add('active'); modeUrlBtn.classList.remove('active');
      fileMode.style.display = ''; urlMode.style.display = 'none';
      urlI.value = '';
    }
    modeUrlBtn.addEventListener('click', activateUrlMode);
    modeFileBtn.addEventListener('click', activateFileMode);

    // --- Chips / progress ---
    function setChip(step, state){
      chips.forEach(c=>{ const s=c.getAttribute('data-step'); c.classList.remove('active','done','error'); if (s===step) c.classList.add(state); });
    }
    function setStage(step,label,progress){ setChip(step,'active'); bar.style.width=(progress||0)+'%'; hint.textContent=label; }
    function clearAlerts(){ note.style.display=err.style.display=ok.style.display='none'; }
    function show(a,msg){ a.textContent=msg; a.style.display='block'; }

    // --- Drag/drop + pick ---
    ;['dragenter','dragover'].forEach(evt=> drop?.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.add('highlight'); }));
    ;['dragleave','drop'].forEach(evt=> drop?.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); drop.classList.remove('highlight'); }));
    drop?.addEventListener('drop', e=>{
      const files = e.dataTransfer && e.dataTransfer.files; if(!files || !files.length) return;
      pickedFile = files[0];
      filePill.textContent = `${pickedFile.name} (${Math.round(pickedFile.size/1024/1024*10)/10} MB)`;
      filePill.style.display = 'inline-block';
      filePill.innerHTML = `${filePill.textContent} <a href="#" id="clearFile">&times;</a>`;
      document.getElementById('clearFile').onclick = (ev)=>{ ev.preventDefault(); pickedFile=null; filePill.style.display='none'; fileInput.value=''; };
    });
    pickBtn?.addEventListener('click', ()=> fileInput.click());
    fileInput?.addEventListener('change', ()=>{
      if(!fileInput.files || !fileInput.files.length) return;
      pickedFile = fileInput.files[0];
      filePill.textContent = `${pickedFile.name} (${Math.round(pickedFile.size/1024/1024*10)/10} MB)`;
      filePill.style.display = 'inline-block';
      filePill.innerHTML = `${filePill.textContent} <a href="#" id="clearFile">&times;</a>`;
      document.getElementById('clearFile').onclick = (ev)=>{ ev.preventDefault(); pickedFile=null; filePill.style.display='none'; fileInput.value=''; };
    });

    // --- Copy transcript ---
    async function copyTranscript(){
      try{
        const text = out.textContent || ''; if(!text) return;
        if(navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
        else { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); }
        show(ok,'Copied to clipboard.'); setTimeout(()=> ok.style.display='none',1500);
      }catch{ show(err,'Copy failed.'); }
    }
    copyBtn.addEventListener('click', copyTranscript);

    // --- Auth (dual mode) ---
    async function checkAuth(){
      try{
        if(API_BASE){ // GH Pages: rely on header token check
          authed = !!AUTH_TOKEN;
          if(authed){
            const theme = (AUTH_TOKEN==='droop') ? 'pink' : (AUTH_TOKEN==='goofy' ? 'light' : 'light');
            const greeting = (AUTH_TOKEN==='droop') ? 'Hey Shmisha ðŸŒ¸' : (AUTH_TOKEN==='goofy' ? 'Hey Sunflower ðŸŒ»' : 'Looks good.');
            applyTheme(theme);
            greet.textContent = greeting; greet.style.display = 'block'; setTimeout(()=>{ greet.style.display='none'; }, 1000);
            loginOverlay.style.display = 'none';
            setTimeout(()=> health(), 200);
            await loadModels();
          }else{
            loginOverlay.style.display = 'flex';
          }
          return;
        }
        // Same-origin cookie flow
        const r = await fetch(EP.check, { credentials:'include' });
        const j = await r.json();
        authed = !!j.authed;
        if(authed){
          applyTheme(j.theme || 'light');
          greet.textContent = j.greeting || 'Hello';
          greet.style.display = 'block'; setTimeout(()=>{ greet.style.display='none'; }, 1000);
          loginOverlay.style.display = 'none';
          setTimeout(()=> health(), 200);
          await loadModels();
        }else{
          loginOverlay.style.display = 'flex';
        }
      }catch{
        loginOverlay.style.display = 'flex';
      }
    }

    async function login(){
      loginErr.style.display='none'; loginOk.style.display='none';
      const password = (pw.value||'').trim();
      if(!password){ loginErr.textContent='Nope.'; loginErr.style.display='block'; return; }

      if(API_BASE){
        // GH Pages: store token and proceed
        AUTH_TOKEN = password;
        if(!['droop','goofy'].includes(AUTH_TOKEN)){ loginErr.textContent='Nope.'; loginErr.style.display='block'; return; }
        loginOk.textContent = AUTH_TOKEN==='droop' ? 'Hey Shmisha ðŸŒ¸' : 'Hey Sunflower ðŸŒ»';
        loginOk.style.display='block';
        setTimeout(checkAuth, 1000);
        return;
      }

      // Same-origin cookie login
      try{
        const r = await fetch(EP.login, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ password })
        });
        if(!r.ok){
          loginErr.textContent = 'Nope.'; loginErr.style.display = 'block';
          return;
        }
        loginOk.textContent = (password==='droop') ? 'Hey Shmisha ðŸŒ¸' : (password==='goofy' ? 'Hey Sunflower ðŸŒ»' : 'Looks good.');
        loginOk.style.display='block';
        setTimeout(checkAuth, 1000);
      }catch(e){
        loginErr.textContent = 'Nope.'; loginErr.style.display = 'block';
      }
    }
    enterBtn.addEventListener('click', login);
    pw.addEventListener('keydown', e=>{ if(e.key==='Enter') login(); });

    async function logout(){
      if(API_BASE){
        AUTH_TOKEN = null;
        authed = false;
        loginOverlay.style.display = 'flex';
        return;
      }
      try{ await fetch(EP.logout, {method:'POST', credentials:'include'}); }catch{}
      authed = false; loginOverlay.style.display = 'flex';
    }
    logoutBtn.addEventListener('click', logout);

    // --- headers helper ---
    function authHeaders(){
      const h = {'Content-Type':'application/json'};
      if(API_BASE && AUTH_TOKEN){ h['X-Auth'] = AUTH_TOKEN; }
      return h;
    }
    function authFileHeaders(){
      const h = {};
      if(API_BASE && AUTH_TOKEN){ h['X-Auth'] = AUTH_TOKEN; }
      return h;
    }

    async function health(){
      try{
        const r = await fetch(EP.health, {method:'GET', headers:authHeaders(), credentials:API_BASE?'omit':'include', cache:'no-store'});
        if(!r.ok) return;
        const j = await r.json();
        gpuMeta.textContent = `GPU: ${j.device}${j.gpu_index!==null?` #${j.gpu_index}`:''} â€¢ ${j.compute_type} â€¢ ${j.model_size}`;
      }catch{}
    }

    async function loadModels(){
      try{
        const r = await fetch(EP.models, {method:'GET', headers:authHeaders(), credentials:API_BASE?'omit':'include', cache:'no-store'});
        if(!r.ok) return;
        const items = await r.json();
        modelKeySel.innerHTML = '<option value="">Default</option>' + items.map(m=>{
          const tag = m.loaded ? ` (${m.device}${m.gpu_index!=null?`#${m.gpu_index}`:''})` : ' (lazy)';
          const def = m.default ? ' *' : '';
          return `<option value="${m.key}">${m.key}${def}${tag}</option>`;
        }).join('');
      }catch{}
    }

    // --- Timers ---
    function fmt(ms){ return (ms/1000).toFixed(1)+'s'; }

    // --- Run transcription ---
    async function run(){
      if(!authed){ loginOverlay.style.display = 'flex'; return; }

      clearAlerts();
      out.style.display='none'; dl.style.display='none'; copyBtn.style.display='none'; meta.style.display='none';
      chips.forEach(c=>c.classList.remove('active','done','error'));
      setStage('queue','Queuedâ€¦', 5);

      const model_key = modelKeySel.value || '';

      const t0 = performance.now();

      try{
        let payload, okStatus=false, statusCode=0;

        if(modeFileBtn.classList.contains('active')){
          if(!pickedFile){ show(err,'Choose a file first.'); return; }
          const lang = langF.value, chunk = Number(chunkF.value||30);
          setStage('download','Uploading fileâ€¦', 25);

          const fd = new FormData();
          fd.append('file', pickedFile);
          fd.append('language', lang);
          fd.append('chunk_size', String(chunk));
          if (model_key) fd.append('model_key', model_key);

          const r = await fetch(EP.transcribeF, {
            method:'POST',
            headers: authFileHeaders(),
            body: fd,
            credentials: API_BASE?'omit':'include'
          });
          statusCode = r.status; okStatus = r.ok;
          payload = r.headers.get('content-type')?.includes('application/json') ? await r.json() : { message: await r.text() };
        } else {
          const url = (urlI.value||'').trim();
          if(!/^https?:\/\//.test(url)){ show(err,'Enter a valid YouTube URL (http/https).'); return; }
          const lang = langI.value, chunk = Number(chunkI.value||30);
          setStage('download','Downloadingâ€¦', 30);

          const r = await fetch(EP.transcribe, {
            method:'POST',
            headers: authHeaders(),
            credentials: API_BASE?'omit':'include',
            body: JSON.stringify({ youtube_url:url, language:lang, chunk_size:chunk, model_key })
          });
          statusCode = r.status; okStatus = r.ok;
          payload = r.headers.get('content-type')?.includes('application/json') ? await r.json() : { message: await r.text() };
        }

        const t1 = performance.now();

        if(!okStatus){
          if(statusCode === 401){ loginOverlay.style.display='flex'; return; }
          if(payload && payload.error_code === 'OOM'){ setChip('transcribe','error'); show(err, (payload.suggestion && payload.suggestion.message) || 'GPU OOM.'); return; }
          if(payload && payload.error_code === 'BUSY'){ setStage('queue', `Server busy â€” retry later`, 10); show(note, `Server busy. Please retry shortly.`); return; }
          show(err, payload.message || payload.error || 'Server error.'); return;
        }

        setStage('transcribe','Transcribingâ€¦', 75);
        setStage('finalize','Finalizingâ€¦', 98);

        const text = payload.transcript || '';
        out.textContent = text; out.style.display='block';
        meta.style.display='block';
        meta.innerHTML = `
          <strong>Model:</strong> ${payload.strategy?.model}
          &nbsp;â€¢&nbsp; <strong>Device:</strong> ${payload.strategy?.device}${payload.strategy?.gpu_index!=null?' #'+payload.strategy?.gpu_index:''}
          &nbsp;â€¢&nbsp; <strong>Compute:</strong> ${payload.strategy?.compute_type}
          &nbsp;â€¢&nbsp; <strong>Chunk:</strong> ${payload.strategy?.chunk_size}
          &nbsp;â€¢&nbsp; <strong>Diar:</strong> ${payload.strategy?.diar_device}
          ${payload.warnings && payload.warnings.length ? '<br><em>'+payload.warnings.join(' â€¢ ')+'</em>' : '' }
        `;
        const blob = new Blob([text], {type:'text/plain'});
        dl.href = URL.createObjectURL(blob); dl.style.display='inline-block'; dl.textContent='Download transcript';
        copyBtn.style.display = 'inline-block';
        show(ok,'Done.'); document.querySelectorAll('.chip').forEach(c=>c.classList.add('done'));

        const totalMs = (t1 - t0);
        (modeFileBtn.classList.contains('active') ? timersFile : timersUrl).textContent = `Total: ${fmt(totalMs)}`;

      } catch(e){ show(err, e.message || 'Request failed.'); }
    }

    // Init
    document.getElementById('go').addEventListener('click', run);
    activateUrlMode();
    checkAuth();  // shows login overlay if needed
  </script>
</body>
</html>
