<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>YouTube Transcription</title>
  <style>
    :root{
      --bg:#f7f7fb; --card:#ffffff; --text:#1f2030; --muted:#6a5b6f;
      --accent:#4c7dff; --accent-2:#3dd6a5; --danger:#c0392b;
      --border:rgba(0,0,0,.12);
      --input-bg:#ffffff; --input-text:#1f2030;
      --track:#eef1f6; --bar-from:#4c7dff; --bar-to:#8fb0ff;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg);}
    .wrap{max-width:960px;margin:40px auto;padding:0 16px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08); overflow:hidden;}
    .head{padding:22px 24px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:12px}
    .title{color:var(--text); font-weight:700; font-size:20px; letter-spacing:.3px; display:flex; align-items:center; gap:10px}
    .badge{padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border); color:var(--muted)}
    .body{padding:24px}
    label{display:block; color:var(--muted); font-size:13px; margin:10px 0 6px}
    input[type="text"], select, input[type="number"], input[type="password"]{
      width:100%; padding:12px 14px; background:var(--input-bg); color:var(--input-text);
      border:1px solid var(--border); border-radius:10px; outline:none;
    }
    input::placeholder{color:#9aa2b2}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:720px){ .grid{grid-template-columns: 1.8fr .7fr .7fr} }
    .row{display:flex; gap:12px; align-items:center}
    .btn{appearance:none; border:0; padding:12px 14px; border-radius:10px; cursor:pointer; font-weight:600; letter-spacing:.2px; transition:.15s}
    .btn-primary{background:var(--accent); color:white}
    .btn-ghost{background:transparent; color:var(--accent); border:1px solid var(--accent)}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .status{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 14px}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid var(--border); color:var(--muted); font-size:12px; background:#fff}
    .chip .dot{width:8px; height:8px; border-radius:50%;}
    .chip.active{color:var(--text); border-color:var(--accent)}
    .chip.active .dot{background:var(--accent)}
    .chip.done{color:#1e8e5b; border-color:#bfe9d8; background:#e9fbf5}
    .chip.done .dot{background:var(--accent-2)}
    .chip.error{color:#a73a3a; border-color:#f3c2c2; background:#ffe9e9}
    .chip.error .dot{background:var(--danger)}
    .progress{height:10px; background:var(--track); border:1px solid var(--border); border-radius:999px; overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--bar-from),var(--bar-to)); transition:width .2s ease}
    .help{color:var(--muted); font-size:12px; margin-top:8px}
    .out{margin-top:18px; padding:16px; background:#f7f7fb; border:1px solid var(--border); color:var(--text); white-space:pre-wrap; border-radius:12px; display:none}
    .meta{margin-top:10px; padding:10px; border:1px dashed var(--border); color:#40465a; font-size:12px; border-radius:10px; display:none; background:#fff}
    .alert{margin-top:12px; padding:12px; border-radius:12px; display:none; font-size:14px; border:1px solid}
    .alert.info{background:#eef3ff; color:#2b3e86; border-color:#cfdafc}
    .alert.success{background:#e9fbf5; color:#1e8e5b; border-color:#bfe9d8}
    .alert.error{background:#ffe9e9; color:#a73a3a; border-color:#f3c2c2}
    .footer{display:flex; gap:10px; margin-top:14px; justify-content:flex-end;}
    a.dl{display:none; text-decoration:none}

    /* Gate */
    .gate{position:fixed; inset:0; background:var(--bg); display:flex; align-items:center; justify-content:center; z-index:9999;}
    .gate .panel{width:min(92vw,440px); background:var(--card); border:1px solid var(--border); border-radius:16px; padding:24px; text-align:center;}
    .gate h2{color:var(--text); margin:0 0 10px}
    .gate p{color:var(--muted); margin:0 0 14px}
    .bigmsg{font-size:28px; font-weight:800; color:var(--text); margin:10px 0 14px; display:none;}
    .tiny{font-size:12px; color:var(--muted); margin-top:8px}
  </style>
</head>
<body>
  <!-- Gate -->
  <div class="gate" id="gate">
    <div class="panel">
      <h2>Welcome</h2>
      <p>Enter password to continue</p>
      <input id="pw" type="password" placeholder="Password"/>
      <div class="row" style="margin-top:12px; justify-content:center">
        <button class="btn btn-primary" id="enterBtn">Enter</button>
      </div>
      <div class="bigmsg" id="bigMsg"></div>
      <div class="tiny" id="gateMsg"></div>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <div class="card">
      <div class="head">
        <div class="title">ðŸŽ§ YouTube Transcription</div>
        <div class="badge" id="gpuMeta">GPU: â€”</div>
      </div>
      <div class="body">
        <div class="grid">
          <div>
            <label for="youtube-url">YouTube URL</label>
            <input id="youtube-url" type="text" placeholder="https://youtu.be/â€¦">
          </div>
          <div>
            <label for="language">Language</label>
            <select id="language">
              <option value="en" selected>English</option>
              <option value="ar">Arabic</option>
              <option value="fr">French</option>
              <option value="es">Spanish</option>
              <option value="de">German</option>
            </select>
          </div>
          <div>
            <label for="chunk">Chunk (sec)</label>
            <input id="chunk" type="number" min="5" max="120" value="30">
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn btn-primary" id="go">Generate Transcript</button>
          <button class="btn btn-ghost" id="retrySafe" style="display:none">Retry in Safe Mode</button>
        </div>

        <div class="status" id="statusChips">
          <span class="chip" data-step="queue"><span class="dot"></span> Queued</span>
          <span class="chip" data-step="download"><span class="dot"></span> Downloading</span>
          <span class="chip" data-step="transcribe"><span class="dot"></span> Transcribing</span>
          <span class="chip" data-step="finalize"><span class="dot"></span> Finalizing</span>
        </div>
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div class="help" id="hint">Ready.</div>

        <div class="alert info" id="note"></div>
        <div class="alert error" id="err"></div>
        <div class="alert success" id="ok"></div>

        <div class="meta" id="meta"></div>

        <pre class="out" id="out"></pre>
        <div class="footer">
          <button class="btn btn-ghost" id="copyBtn" style="display:none">Copy</button>
          <a class="btn btn-ghost dl" id="dl" download="transcript.txt">Download transcript</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // API base (GitHub Pages -> ngrok; else same-origin)
    const API_BASE = location.hostname.endsWith('github.io')
      ? 'https://fair-joint-dinosaur.ngrok-free.app'
      : '';
    const STREAM_URL = API_BASE + '/transcribe/stream';
    const HEALTH_URL = API_BASE + '/healthz';

    // Themes (soft)
    const THEMES = {
      pink:  { bg:'#fff5fb', card:'#ffffff', text:'#1f2030', muted:'#6a5b6f',
               accent:'#e16bbd', accent2:'#ff9ecf', border:'rgba(0,0,0,.10)',
               inputBg:'#ffffff', inputText:'#1f2030', track:'#ffe6f3', barFrom:'#ff7fc7', barTo:'#ffb3dd' },
      light: { bg:'#ffffff', card:'#ffffff', text:'#1f2030', muted:'#5c6473',
               accent:'#4c7dff', accent2:'#3dd6a5', border:'rgba(0,0,0,.12)',
               inputBg:'#ffffff', inputText:'#1f2030', track:'#eef1f6', barFrom:'#4c7dff', barTo:'#8fb0ff' }
    };
    function applyTheme(t){
      const r = document.documentElement.style;
      r.setProperty('--bg', t.bg); r.setProperty('--card', t.card);
      r.setProperty('--text', t.text); r.setProperty('--muted', t.muted);
      r.setProperty('--accent', t.accent); r.setProperty('--accent-2', t.accent2);
      r.setProperty('--border', t.border);
      r.setProperty('--input-bg', t.inputBg); r.setProperty('--input-text', t.inputText);
      r.setProperty('--track', t.track); r.setProperty('--bar-from', t.barFrom); r.setProperty('--bar-to', t.barTo);
      document.body.style.background = t.bg;
    }

    // Gate
    const gate = document.getElementById('gate');
    const app  = document.getElementById('app');
    const pw   = document.getElementById('pw');
    const enterBtn = document.getElementById('enterBtn');
    const gateMsg = document.getElementById('gateMsg');
    const bigMsg  = document.getElementById('bigMsg');

    function unlock(theme, message){
      applyTheme(theme);
      bigMsg.textContent = message;
      bigMsg.style.display = 'block';
      gateMsg.textContent = '';
      setTimeout(() => {
        gate.style.display = 'none';
        app.style.display = 'block';
        bigMsg.style.display = 'none';
      }, 1000);
    }
    enterBtn.addEventListener('click', ()=>{
      const val = (pw.value||'').trim().toLowerCase();
      if(val === 'droop'){ unlock(THEMES.pink,  'Hey Shmisha ðŸŒ¸'); }
      else if(val === 'goofy'){ unlock(THEMES.light, 'Hey Sunflower ðŸŒ»'); }
      else{ gateMsg.textContent = 'Nope.'; }
    });
    pw.addEventListener('keydown', (e)=>{ if(e.key==='Enter') enterBtn.click(); });

    // UI refs
    const $ = (id)=>document.getElementById(id);
    const go = $('go'), retrySafe = $('retrySafe');
    const urlI = $('youtube-url'), langI = $('language'), chunkI = $('chunk');
    const chips = document.querySelectorAll('.chip');
    const bar = $('bar'), hint = $('hint');
    const note = $('note'), err = $('err'), ok = $('ok');
    const out = $('out'), dl = $('dl'), meta = $('meta'), gpuMeta = $('gpuMeta');
    const copyBtn = $('copyBtn');

    function setChip(step, state){
      chips.forEach(c=>{
        const s = c.getAttribute('data-step');
        c.classList.remove('active','done','error');
        if (s===step) c.classList.add(state);
      });
    }
    function setStage(step,label,progress){
      setChip(step,'active'); bar.style.width = (progress||0) + '%'; hint.textContent = label;
    }
    function clearAlerts(){ note.style.display=err.style.display=ok.style.display='none'; }
    function show(a, msg){ a.textContent = msg; a.style.display='block'; }

    async function health(){
      try{
        const r = await fetch(HEALTH_URL, {cache:'no-store'});
        if(!r.ok) return;
        const j = await r.json();
        gpuMeta.textContent = `GPU: ${j.device}${j.gpu_index!==null?` #${j.gpu_index}`:''} â€¢ ${j.compute_type} â€¢ ${j.model_size}`;
      }catch{}
    }
    health();

    // SSE with retry (3 attempts)
    function openSSEWithRetry(url, handlers) {
      let tries = 0, es;
      const connect = () => {
        const sid = Date.now();
        es = new EventSource(url + (url.includes('?') ? '&' : '?') + 'sid=' + sid);
        es.addEventListener('progress', e => handlers.onProgress(JSON.parse(e.data)));
        es.addEventListener('advise',   e => handlers.onAdvise(JSON.parse(e.data)));
        es.addEventListener('server_error', e => {
          const d = JSON.parse(e.data || '{}');
          handlers.onServerError(d);
          es.close();
        });
        es.addEventListener('done',     e => { handlers.onDone(JSON.parse(e.data)); es.close(); });
        es.addEventListener('error',    () => {
          es.close(); tries += 1;
          if (tries <= 3) {
            note.style.display='block';
            note.textContent = `Connection hiccupâ€¦ retrying (${tries}/3)â€¦`;
            setTimeout(connect, [800,1500,3000][tries-1]);
          } else {
            handlers.onHardError();
          }
        });
      };
      connect();
      return { close: ()=> es && es.close() };
    }

    // Copy helper
    async function copyTranscript(){
      try{
        const text = out.textContent || '';
        if (!text) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          const ta = document.createElement('textarea');
          ta.value = text; document.body.appendChild(ta);
          ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        }
        show(ok, 'Copied to clipboard.');
        setTimeout(()=>{ ok.style.display='none'; }, 1500);
      } catch(e){
        show(err, 'Copy failed.');
      }
    }
    copyBtn.addEventListener('click', copyTranscript);

    function start() {
      clearAlerts();
      out.style.display='none'; dl.style.display='none'; copyBtn.style.display='none'; meta.style.display='none';
      go.disabled = true; retrySafe.disabled = true;

      chips.forEach(c=>c.classList.remove('active','done','error'));
      setStage('queue','Queuedâ€¦', 1);

      const url = (urlI.value||'').trim();
      if(!/^https?:\/\//.test(url)){ show(err,'Please enter a valid YouTube URL (http/https).'); go.disabled=false; return; }
      const lang = langI.value;
      const chunk = Number(chunkI.value || 30);

      const qs = new URLSearchParams({ youtube_url:url, language:lang, chunk_size:String(chunk), safe_mode:'0' }).toString();
      const stream = openSSEWithRetry(`${STREAM_URL}?${qs}`, {
        onProgress: (p)=>{
          if(p.stage === 'downloading'){ setStage('download', `Downloadingâ€¦ ${p.pct!=null? p.pct+'%':''} ${p.note? 'â€¢ '+p.note:''}`, p.pct||10); }
          else if(p.stage === 'transcribing'){ setStage('transcribe', `Transcribingâ€¦ ${p.pct!=null? p.pct+'%':''}`, p.pct||80); }
          else if(p.stage === 'finalizing'){ setStage('finalize', 'Finalizingâ€¦', p.pct||98); }
        },
        onAdvise: (a)=>{
          if(a.error_code === 'OOM'){
            setChip('transcribe','error');
            show(err, (a.suggestion && a.suggestion.message) || 'GPU OOM.');
            retrySafe.style.display='inline-block';
            const nextChunk = (a.suggestion && a.suggestion.suggested_chunk_size) || Math.max(10, Math.floor(chunk/2));
            retrySafe.onclick = ()=>{
              stream.close();
              const qs2 = new URLSearchParams({ youtube_url:url, language:lang, chunk_size:String(nextChunk), safe_mode:'1' }).toString();
              startSafe(`${STREAM_URL}?${qs2}`);
            };
          } else if (a.error_code === 'BUSY'){
            setStage('queue', `Server busy â€” retrying in ${a.retry_after||2}sâ€¦`, 5);
            setTimeout(()=>{ stream.close(); start(); }, (a.retry_after||2)*1000);
          }
        },
        onServerError: (d)=>{
          setChip('transcribe','error');
          show(err, d.message || 'Server error.');
          go.disabled = false; retrySafe.disabled = false;
        },
        onDone: (d)=>{
          setStage('finalize','Done.',100);
          out.textContent = d.transcript || '';
          out.style.display='block';
          meta.style.display='block';
          meta.innerHTML = `
            <strong>Device:</strong> ${d.strategy?.device}${d.strategy?.gpu_index!=null?' #'+d.strategy?.gpu_index:''}
            &nbsp;â€¢&nbsp; <strong>Compute:</strong> ${d.strategy?.compute_type}
            &nbsp;â€¢&nbsp; <strong>Chunk:</strong> ${d.strategy?.chunk_size}
            &nbsp;â€¢&nbsp; <strong>Diar:</strong> ${d.strategy?.diar_device}
            ${d.warnings && d.warnings.length ? '<br><em>'+d.warnings.join(' â€¢ ')+'</em>' : '' }
          `;
          const blob = new Blob([d.transcript||''], {type:'text/plain'});
          dl.href = URL.createObjectURL(blob);
          dl.style.display = 'inline-block';
          dl.textContent = 'Download transcript';
          copyBtn.style.display = 'inline-block';
          show(ok,'Done.');
          chips.forEach(c=>c.classList.add('done'));
          retrySafe.style.display='none';
          go.disabled = false; retrySafe.disabled = false;
        },
        onHardError: ()=>{
          setChip('transcribe','error');
          show(err, 'Stream error.');
          go.disabled = false; retrySafe.disabled = false;
        }
      });
    }

    function startSafe(url2){
      clearAlerts();
      setStage('transcribe','Transcribing (Safe Mode)â€¦', 10);
      const s2 = openSSEWithRetry(url2, {
        onProgress: (p)=>{
          if(p.stage === 'transcribing'){ setStage('transcribe', `Transcribingâ€¦ ${p.pct!=null? p.pct+'%':''}`, p.pct||60); }
          else if(p.stage === 'finalizing'){ setStage('finalize', 'Finalizingâ€¦', p.pct||98); }
        },
        onAdvise: ()=>{},
        onServerError: (d)=>{
          setChip('transcribe','error');
          show(err, d.message || 'Server error.');
          go.disabled = false; retrySafe.disabled = false;
        },
        onDone: (d)=>{
          setStage('finalize','Done.',100);
          out.textContent = d.transcript || '';
          out.style.display='block';
          const blob = new Blob([d.transcript||''], {type:'text/plain'});
          dl.href = URL.createObjectURL(blob);
          dl.style.display = 'inline-block';
          dl.textContent = 'Download transcript';
          copyBtn.style.display = 'inline-block';
          show(ok,'Done.');
          chips.forEach(c=>c.classList.add('done'));
          go.disabled = false; retrySafe.disabled = false;
        },
        onHardError: ()=>{
          setChip('transcribe','error');
          show(err, 'Stream error.');
          go.disabled = false;
        }
      });
    }

    document.getElementById('go').addEventListener('click', start);
  </script>
</body>
</html>
