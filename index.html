<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>YouTube Transcription</title>
  <style>
    :root{
      --bg:#0b1020; --card:#111733; --muted:#96a0c2; --text:#e8ecff; --accent:#6c8cff; --accent-2:#3dd6a5; --danger:#ff6b6b;
      --border: rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:linear-gradient(180deg,#0b1020,#0a0d1a);}
    .wrap{max-width:960px;margin:40px auto;padding:0 16px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25); overflow:hidden;}
    .head{padding:22px 24px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:12px}
    .title{color:var(--text); font-weight:700; font-size:20px; letter-spacing:.3px; display:flex; align-items:center; gap:10px}
    .badge{padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border); color:var(--muted)}
    .body{padding:24px}
    label{display:block; color:var(--muted); font-size:13px; margin:10px 0 6px}
    input[type="text"], select, input[type="number"]{
      width:100%; padding:12px 14px; background:#0d1330; color:var(--text); border:1px solid var(--border); border-radius:10px; outline:none;
    }
    input::placeholder{color:#7580a8}
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:720px){ .grid{grid-template-columns: 1.8fr .7fr .7fr} }
    .row{display:flex; gap:12px}
    .btn{appearance:none; border:0; padding:12px 14px; border-radius:10px; cursor:pointer; font-weight:600; letter-spacing:.2px; transition:.2s}
    .btn-primary{background:var(--accent); color:white}
    .btn-ghost{background:transparent; color:var(--accent); border:1px solid var(--accent)}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .status{display:flex; gap:8px; flex-wrap:wrap; margin:10px 0 14px}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--border); color:var(--muted); font-size:12px}
    .chip .dot{width:8px; height:8px; border-radius:50%;}
    .chip.active{color:var(--text); border-color:#2b376a}
    .chip.active .dot{background:var(--accent)}
    .chip.done{color:#9ff0cf; border-color:#2b6a53}
    .chip.done .dot{background:var(--accent-2)}
    .chip.error{color:#ffd6d6; border-color:#6a2b2b}
    .chip.error .dot{background:var(--danger)}
    .progress{height:10px; background:#0d1330; border:1px solid var(--border); border-radius:999px; overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),#8aa6ff); transition:width .25s ease}
    .help{color:var(--muted); font-size:12px; margin-top:8px}
    .out{margin-top:18px; padding:16px; background:#0b1230; border:1px solid var(--border); color:#d8ddff; white-space:pre-wrap; border-radius:12px; display:none}
    .meta{margin-top:10px; padding:10px; border:1px dashed var(--border); color:#bfc8ff; font-size:12px; border-radius:10px; display:none}
    .alert{margin-top:12px; padding:12px; border-radius:12px; display:none; font-size:14px; border:1px solid}
    .alert.info{background:#0c153a; color:#bcd0ff; border-color:#233066}
    .alert.success{background:#0e2b27; color:#c9ffe9; border-color:#265e56}
    .alert.error{background:#2b1212; color:#ffd3d3; border-color:#6a2b2b}
    .footer{display:flex; gap:10px; margin-top:14px}
    a.dl{display:none; text-decoration:none}

    /* Theme panel */
    .theme{display:flex; align-items:center; gap:8px}
    .theme-panel{position:absolute; right:16px; top:64px; background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px; display:none; z-index:3}
    .theme-panel label{font-size:12px; margin-top:4px}
    .swatch{display:flex; gap:8px; align-items:center}
    .theme .btn-ghost{padding:8px 10px}

    /* Password gate */
    .gate{
      position:fixed; inset:0; background:linear-gradient(180deg,#0b1020,#0a0d1a); display:flex; align-items:center; justify-content:center; z-index:9999;
    }
    .gate .panel{
      width:min(92vw,440px); background:var(--card); border:1px solid var(--border); border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.35); text-align:center;
    }
    .gate h2{color:var(--text); margin:0 0 10px}
    .gate p{color:var(--muted); margin:0 0 14px}
    .gate input[type="password"]{width:100%; padding:12px 14px; background:#0d1330; color:var(--text); border:1px solid var(--border); border-radius:10px; outline:none;}
    .gate .tiny{font-size:12px; color:var(--muted); margin-top:8px}
    .fadeout{animation:fadeout .5s ease forwards}
    @keyframes fadeout{to{opacity:0; visibility:hidden}}
  </style>
</head>
<body>
  <!-- Password Gate -->
  <div class="gate" id="gate">
    <div class="panel">
      <h2>Welcome</h2>
      <p>Enter password to continue</p>
      <input id="pw" type="password" placeholder="Password"/>
      <div class="row" style="margin-top:12px; justify-content:center">
        <button class="btn btn-primary" id="enterBtn">Enter</button>
      </div>
      <div class="tiny" id="gateMsg"></div>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <div class="card">
      <div class="head" style="position:relative">
        <div class="title">🎧 YouTube Transcription</div>
        <div class="theme">
          <button class="btn btn-ghost" id="themeBtn">🎨 Theme</button>
          <div class="badge" id="gpuMeta">GPU: —</div>
          <div class="theme-panel" id="themePanel">
            <div class="swatch">
              <label>Accent</label>
              <input type="color" id="cAccent" value="#6c8cff">
            </div>
            <div class="swatch">
              <label>Accent 2</label>
              <input type="color" id="cAccent2" value="#3dd6a5">
            </div>
            <div class="swatch">
              <label>Background</label>
              <input type="color" id="cBg" value="#0b1020">
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn btn-primary" id="saveTheme">Save</button>
              <button class="btn btn-ghost" id="resetTheme">Reset</button>
            </div>
          </div>
        </div>
      </div>

      <div class="body">
        <div class="grid">
          <div>
            <label for="youtube-url">YouTube URL</label>
            <input id="youtube-url" type="text" placeholder="https://youtu.be/…">
          </div>
          <div>
            <label for="language">Language</label>
            <select id="language">
              <option value="en" selected>English</option>
              <option value="ar">Arabic</option>
              <option value="fr">French</option>
              <option value="es">Spanish</option>
              <option value="de">German</option>
            </select>
          </div>
          <div>
            <label for="chunk">Chunk (sec)</label>
            <input id="chunk" type="number" min="5" max="120" value="30">
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn btn-primary" id="go">Generate Transcript</button>
          <button class="btn btn-ghost" id="retrySafe" style="display:none">Retry in Safe Mode</button>
        </div>

        <div class="status" id="statusChips">
          <span class="chip" data-step="queue"><span class="dot"></span> Queued</span>
          <span class="chip" data-step="download"><span class="dot"></span> Downloading</span>
          <span class="chip" data-step="transcribe"><span class="dot"></span> Transcribing</span>
          <span class="chip" data-step="finalize"><span class="dot"></span> Finalizing</span>
        </div>
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div class="help" id="hint">Ready.</div>

        <div class="alert info" id="note"></div>
        <div class="alert error" id="err"></div>
        <div class="alert success" id="ok"></div>

        <div class="meta" id="meta"></div>

        <pre class="out" id="out"></pre>
        <div class="footer">
          <a class="btn btn-ghost dl" id="dl" download="transcript.txt">Download Transcript</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- API endpoint ---
    const API_URL = location.hostname.endsWith('github.io')
      ? 'https://fair-joint-dinosaur.ngrok-free.app/transcribe' // <— update when ngrok rotates
      : '/transcribe';

    // --- Password gate ---
    const gate = document.getElementById('gate');
    const app  = document.getElementById('app');
    const pw   = document.getElementById('pw');
    const enterBtn = document.getElementById('enterBtn');
    const gateMsg = document.getElementById('gateMsg');

    function unlock(){
      gateMsg.textContent = 'Hey shmisha ❤️';
      localStorage.setItem('authed','1');
      setTimeout(()=>{ gate.classList.add('fadeout'); setTimeout(()=>{ gate.style.display='none'; app.style.display='block'; }, 450); }, 400);
    }
    function checkAuth(){
      if(localStorage.getItem('authed') === '1'){ gate.style.display='none'; app.style.display='block'; }
    }
    enterBtn.addEventListener('click', ()=>{
      const val = (pw.value||'').trim();
      if(val === 'droop'){ unlock(); }
      else{ gateMsg.textContent = 'Nope.'; }
    });
    pw.addEventListener('keydown', (e)=>{ if(e.key==='Enter') enterBtn.click(); });
    checkAuth();

    // --- Theme picker ---
    const themeBtn = document.getElementById('themeBtn');
    const themePanel = document.getElementById('themePanel');
    const cAccent = document.getElementById('cAccent');
    const cAccent2 = document.getElementById('cAccent2');
    const cBg = document.getElementById('cBg');
    const saveTheme = document.getElementById('saveTheme');
    const resetTheme = document.getElementById('resetTheme');

    function loadTheme(){
      const t = JSON.parse(localStorage.getItem('theme')||'{}');
      if(t.accent) document.documentElement.style.setProperty('--accent', t.accent), cAccent.value=t.accent;
      if(t.accent2) document.documentElement.style.setProperty('--accent-2', t.accent2), cAccent2.value=t.accent2;
      if(t.bg){
        document.documentElement.style.setProperty('--bg', t.bg);
        cBg.value = t.bg;
        document.body.style.background = `linear-gradient(180deg, ${t.bg}, #0a0d1a)`;
      }
    }
    function saveThemeNow(){
      const t = { accent: cAccent.value, accent2: cAccent2.value, bg: cBg.value };
      localStorage.setItem('theme', JSON.stringify(t));
      loadTheme();
    }
    function resetThemeNow(){
      localStorage.removeItem('theme');
      document.documentElement.style.setProperty('--accent', '#6c8cff');
      document.documentElement.style.setProperty('--accent-2', '#3dd6a5');
      document.documentElement.style.setProperty('--bg', '#0b1020');
      document.body.style.background = 'linear-gradient(180deg,#0b1020,#0a0d1a)';
      cAccent.value = '#6c8cff'; cAccent2.value = '#3dd6a5'; cBg.value = '#0b1020';
    }
    themeBtn.addEventListener('click', ()=>{
      themePanel.style.display = themePanel.style.display==='block' ? 'none' : 'block';
    });
    saveTheme.addEventListener('click', saveThemeNow);
    resetTheme.addEventListener('click', resetThemeNow);
    loadTheme();

    // --- UI refs ---
    const el = (id)=>document.getElementById(id);
    const go = el('go'), retrySafe = el('retrySafe');
    const urlI = el('youtube-url'), langI = el('language'), chunkI = el('chunk');
    const chips = document.querySelectorAll('.chip');
    const bar = el('bar'), hint = el('hint');
    const note = el('note'), err = el('err'), ok = el('ok');
    const out = el('out'), dl = el('dl'), meta = el('meta'), gpuMeta = el('gpuMeta');

    // --- helpers ---
    function setChip(step, state){ // state: active | done | error | reset
      chips.forEach(c=>{
        const s = c.getAttribute('data-step');
        c.classList.remove('active','done','error');
        if (state==='reset') return;
        if (s===step) c.classList.add(state);
      });
    }
    function setStage(step,label,progress){
      setChip(step,'active');
      bar.style.width = progress + '%';
      hint.textContent = label;
    }
    function clearAlerts(){ note.style.display=err.style.display=ok.style.display='none'; }
    function show(a, msg){ a.textContent = msg; a.style.display='block'; }

    async function health(){
      try{
        const r = await fetch(API_URL.replace('/transcribe','/healthz'), {cache:'no-store'});
        if(!r.ok) return;
        const j = await r.json();
        gpuMeta.textContent = `GPU: ${j.device}${j.gpu_index!==null?` #${j.gpu_index}`:''} • ${j.compute_type} • ${j.model_size}`;
      }catch{}
    }
    health();

    // Simulated progress controller
    let tick=null, target=0;
    function startSimulatedProgress(){
      let p=0; target=10; bar.style.width='0%';
      tick = setInterval(()=>{
        if(p<target){ p += Math.max(0.3, (target-p)*0.08); bar.style.width=p+'%'; }
      }, 80);
      return ()=>{ clearInterval(tick); bar.style.width='100%'; };
    }
    function bump(to,label,step){ target=to; setStage(step,label,to); }

    async function run(safe=false, overrideChunk=null){
      clearAlerts();
      out.style.display='none'; dl.style.display='none'; meta.style.display='none';
      go.disabled = true; retrySafe.disabled = true;

      // reset chips
      chips.forEach(c=>c.classList.remove('active','done','error'));
      setChip('queue','active');
      bar.style.width='0%'; hint.textContent='Queued…';

      // basic validation
      const url = (urlI.value||'').trim();
      if(!/^https?:\/\//.test(url)){ show(err,'Please enter a valid YouTube URL (http/https).'); go.disabled=false; return; }

      const lang = langI.value;
      const chunk = Number(overrideChunk ?? (chunkI.value||30));

      // kick off simulated progress
      const finish = startSimulatedProgress();
      bump(15,'Downloading audio…','download');

      try{
        // After a moment, move to “Transcribing…”
        setTimeout(()=> bump(85,'Transcribing…','transcribe'), 900);

        const res = await fetch(API_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            youtube_url: url,
            language: lang,
            chunk_size: chunk,
            safe_mode: safe
          })
        });

        const ct = res.headers.get('content-type') || '';
        const payload = ct.includes('application/json') ? await res.json() : { error_code:'SERVER_ERROR', message: await res.text() };

        if(!res.ok){
          if(payload && payload.error_code==='OOM'){
            setChip('transcribe','error'); bump(90,'Out of memory — consider Safe Mode','finalize');
            show(err, (payload.suggestion && payload.suggestion.message) || 'GPU memory was insufficient.');
            retrySafe.style.display='inline-block';
            const nextChunk = (payload.suggestion && payload.suggestion.suggested_chunk_size) || Math.max(10, Math.floor(chunk/2));
            retrySafe.onclick = ()=> run(true, nextChunk);
            return;
          }
          if(payload && payload.error_code==='BUSY'){
            setChip('queue','active'); bump(5,'Server busy — retrying shortly…','queue');
            show(note, `Server busy. Auto-retrying in ${payload.retry_after || 2}s…`);
            setTimeout(()=> run(safe, chunk), (payload.retry_after || 2)*1000);
            return;
          }
          setChip('transcribe','error');
          show(err, payload.message || 'Server error.');
          return;
        }

        bump(98,'Finalizing…','finalize');
        const text = payload.transcript || '';
        out.textContent = text; out.style.display='block';
        meta.style.display = 'block';
        meta.innerHTML = `
          <strong>Device:</strong> ${payload.strategy?.device}${payload.strategy?.gpu_index!=null?' #'+payload.strategy?.gpu_index:''}
          &nbsp;•&nbsp; <strong>Compute:</strong> ${payload.strategy?.compute_type}
          &nbsp;•&nbsp; <strong>Chunk:</strong> ${payload.strategy?.chunk_size}
          &nbsp;•&nbsp; <strong>Diar:</strong> ${payload.strategy?.diar_device}
          ${payload.warnings && payload.warnings.length ? '<br><em>'+payload.warnings.join(' • ')+'</em>' : '' }
        `;

        // download link
        const blob = new Blob([text], {type:'text/plain'});
        dl.href = URL.createObjectURL(blob);
        dl.style.display = 'inline-block';
        dl.textContent = 'Download transcript';

        show(ok,'Done.');
        chips.forEach(c=>c.classList.add('done'));
        retrySafe.style.display='none';
      } catch(e){
        setChip('transcribe','error');
        show(err, e.message || 'Request failed.');
      } finally{
        finish();
        go.disabled = false; retrySafe.disabled = false;
      }
    }

    go.addEventListener('click', ()=> run(false));
  </script>
</body>
</html>
